// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts,
// or vendor/assets/javascripts of plugins, if any, can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// compiled file.
//
// Read Sprockets README (https://github.com/sstephenson/sprockets#sprockets-directives) for details
// about supported directives.
//
//= require jquery
//= require jquery_ujs
//= require_tree .

/***********************************************************************************************************************
/ Main
/**********************************************************************************************************************/

var loaders, pages;

var currentUser = null, profileId = null, providerId = null, bookingId = null, rate = 0, back = null, favorites = [], messages = [];
var users = null;
var global_info = null;
var filter_settings = {
    category: {label: 'Categories', value: null},
    subcategory: {label: 'Subcategories', value: null},
    city: {label: 'City', value: null},
    college: {label: 'College', value: null},
    hourly_rate_from: {label: '0', value: 0},
    hourly_rate_to: {label: '200', value: 200},
    rate_from: {label: '0', value: 0},
    rate_to: {label: '5', value: 5},
    subcategories: []
}
var bookings = {};
var booking = {
    budget: null,
    due_date: null,
    description: null
}
var avatar_change = false;
var chart_options = {
    chart: {
        type: 'areaspline',
        renderTo: 'bookings-chart',
        margin: 0,
        backgroundColor: 'transparent'
    },
    credits: {
        enabled: false
    },
    title: {
        text: '',
    },
    xAxis: {
        type: 'datetime',
        lineColor: '#333'
    },
    yAxis: {
        title: {
            enabled: false
        },
        plotLines: [{
            value: 0,
            width: 1,
            color: '#000'
        }],
        labels: {
            style: {
                color: '#ddd'
            }
        },
        min: 0,
        gridLineColor: '#eee',
        gridLineDashStyle: 'longdash'
    },
    legend: {
        layout: 'horizontal',
        align: 'center',
        verticalAlign: 'bottom',
        borderWidth: 0,
        enabled: false
    },
    plotOptions: {
        areaspline: {
            lineWidth: 3,
            fillOpacity: 0.1,
            marker: {
                symbol: 'circle',
                fillColor: '#ffffff',
                lineWidth: 2,
                lineColor: null,
                radius: 3
            }
        }
    },
    series: [{
        color: '#75b9dc',
        data: []
    }]
};

$(window).on('load', function () {

    pages = {

        'active': '',

        'home': {

            'href': '',
            'load': function () {

                $('#background').removeClass('disabled');
                $('#admin-panel').removeClass('disabled');

                rF = {

                    /* Name, email, zip fields and send button. */

                    'href': '/presentation/subscribe',

                    'e': $('#register-form-email'),

                };

                cF = $('#contact-form');
                cF = {

                    /* Name, email, phone number, reason for contact, message fields and contact button. */

                    'href': '/send_message',

                    'n': cF.find('.name'),
                    'e': cF.find('.email'),
                    'm': cF.find('.message')

                };

            }

        },

        'login': {

            'href': '/login',
            'load': function () {

                sF = $('#sign-in');
                sF = {

                    'href': '/user/signin',

                    'email': sF.find('.email'),
                    'password': sF.find('.password')

                };

            }

        },

        'signup': {

            'href': '/signup',
            'load': function () {

                if ($('#admin-panel')) {
                    $('#admin-panel').addClass('disabled');
                }
                if ($('#background')) {
                    $('#background').addClass('disabled');
                }

                sF = $('#sign-up-form');
                sF = {

                    'href': '/user/signup',

                    'a': sF.find('.image-upload #avatar'),

                    'n': sF.find('.name'),
                    'e': sF.find('.email'),
                    'p': sF.find('.password'),
                    'pc': sF.find('.password_confirmation'),
                    'as': false
                }

                sF.a.on('change', function () {
                    sF.as = true;
                });

                $('#sp-checkbox').click(function() {
                    if($('#is_provider').val() == 0) {
                        $('#is_provider').val(1);
                        $('#sp-checkbox').css('background-position', '0px -55px');
                    }
                    else {
                        $('#is_provider').val(0);
                        $('#sp-checkbox').css('background-position', '0px 0px');
                    }
                });
            }

        },

        'signup_service_provider': {
            'href': '/signup_service_provider',
            'load': function () {
                if ($('#admin-panel')) {
                    $('#admin-panel').addClass('disabled');
                }
                if ($('#background')) {
                    $('#background').addClass('disabled').css('overflow-y', 'scroll');;
                }

                sF = $('#sign-up-sp-form');
                sF = {

                    'href': '/user/set_details',

                    'street': sF.find('.street'),
                    'state': sF.find('#state_id'),
                    'zip': sF.find('.zip'),
                    'description': sF.find('.desc'),
                    'summary': sF.find('.summary'),
                    'hourly_rate': sF.find('.hourly_rate'),
                    'experience': sF.find('.experience')

                };

                $.ajax({
                    url: 'http://backend.liquidtalent.com/get_info',
                    error: function (error) {
                        alert("Problem with connecting to the server");
                        console.log(error);
                    }
                }).done(function (data) {
                            data['response']['cities'].forEach(function (item) {
                                $('#cities').append('<div onclick="setCity(' + item['id'] + ', \'' + item['name'] + '\');">' + item['name'] + '</div>')
                            })

                            data['response']['categories'].forEach(function (item) {
                                $('#skills').append('<div onclick="setSkills(' + item['id'] + ', \'' + item['name'] + '\');">' + item['name'] + '</div>')
                            })
                });

                Object.keys(states).forEach(function (key) {
                    $('#states').append('<div onclick="setState(\'' + states[key] + '\', \'' + key + '\');">' + key + '</div>')
                })

                $('.city').click(function () {
                    $('#cities').show();
                });

                $('.skills').click(function () {
                    $('#skills').show();
                });

                $('.state').click(function () {
                    $('#states').show();
                });
            }
        },

        'search': {

            'href': '/search',
            'load': function () {

                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                if(users == null) {
                    filterUsers(listSearch);
                }
                else {
                    listSearch(users);
                }

                prepareFilter();
            }

        },

        'map': {

            'href': '/map',
            'load': function () {

                if ($('#background.disabled')) { $('#background').removeClass('disabled'); }
                if ($('#admin-panel.disabled')) { $('#admin-panel').removeClass('disabled'); }

                map = $('#map-overlay');
                map = {

                    'markers': [],

                    'googleMap': new google.maps.Map( document.getElementById('map'), {
                        center: new google.maps.LatLng(40.5403, -73.5463),
                        zoom: 8,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    }),

                    'popUp': {
                        'overlay': $('#map-overlay'),
                        'image': map.find('.avatar'),
                        'description': map.find('.description'),
                        'distance': map.find('.distance'),
                        'linkedIn': map.find('.linkedin-icon'),
                        'title': map.find('.base .title'),
                        'favorite': map.find('.favorite-button'),
                        'play': map.find('.play-button'),
                        'LTDrop': map.find('.lt-drop'),
                        'stars': map.find('.stars .star')
                    }

                };

                map.popUp.overlay.on('click', function (event) {
                    if ($(event.target).prop('id') === 'map-overlay') {
                        map.popUp.overlay.animate({ opacity: 0 }, 1000, 'linear').promise().done(function () {
                            map.popUp.overlay.css('display', 'none');
                        });
                    }
                });

                if (users === null) { filterUsers(mapSearch); }
                else { mapSearch(users); }

                prepareFilter();
            }

        },

        'favorites': {

            'href': '/favorites',
            'load': function () {

                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                loadFavorites();

                $('.black-button').click(function() {
                    if($('.removeFavorite').first().is(':visible')) {
                        $('.removeFavorite').hide();
                    }
                    else {
                        $('.removeFavorite').show();
                    }
                });
            }

        },

        'stats': {

            'href': '/stats',
            'load': function () {

                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                loadStats(7);

                $('#term-selector').click(function () {
                    if($('#term-selector-options').is(':visible')) {
                        $('#term-selector-options').hide();
                    }
                    else {
                        $('#term-selector-options').show();
                    }
                });

            }

        },

        'profile': {
            'href': '/profile',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                loadProfile()
            }
        },

        'video_upload': {
            'href': '/video_upload',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }
            }
        },

        'hire': {
            'href': '/hire',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                loadHire();

                $( ".due-date" ).datepicker();
                $( ".due-date" ).datepicker("option", "dateFormat", "yy-mm-dd");
            }
        },

        'hire_confirm': {
            'href': '/hire_confirm',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                $('#total-amount').html(booking.budget);

                if(currentUser.stripe_customer_id == null) {
                    $('#cc-form').show();
                    $('#booking-form').hide();
                }
                else {
                    $('#cc-form').hide();
                    $('#booking-form').show();
                }
            }
        },

        'hire_accept': {
            'href': '/hire_accept',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                $('#total-amount').html(bookings[bookingId].booking.budget);

                if(currentUser.stripe_recipient_id == null) {
                    $('#bank-form').show();
                    $('#booking-form').hide();
                }
                else {
                    $('#bank-form').hide();
                    $('#booking-form').show();
                }
            }
        },

        'projects': {
            'href': '/projects',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                loadProjects();
            }
        },

        'rate': {
            'href': '/rate',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                loadRate();
            }
        },

        'settings': {
            'href': '/settings',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                /*
                if(currentUser === null) {
                    showPlaceholder('Settings');
                    return false;
                }
                */

                cF = $('#settings-contact');
                cF = {
                    /* Name, email, phone number, reason for contact, message fields and contact button. */
                    'href': '/send_message',

                    'n': cF.find('.name'),
                    'e': cF.find('.email'),
                    'm': cF.find('.message')
                };
            }
        },

        'update_demander': {
            'href': '/update_demander',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                $.ajax({
                    url: 'http://backend.liquidtalent.com/get_info',
                    error: function (error) {
                        alert("Problem with connecting to the server");
                    }
                }).done(function (data) {
                            data['response']['categories'].forEach(function (item) {
                                $('#categories').append('<div onclick="setCategory(' + item['id'] + ', \'' + item['name'] + '\');">' + item['name'] + '</div>')

                                if(currentUser.category_id * 1 == item['id'] * 1) {
                                    $('.category').val(item['name']);
                                }
                            })
                        });

                $('.category').click(function () {
                    if($('#categories').is(':visible')) {
                        $('#categories').hide();
                    }
                    else {
                        $('#categories').show();
                    }
                });

                $('#category_id').val(currentUser.category_id);

                $('.name').val(currentUser.name);
                $('.email').val(currentUser.email);
                $('.zip').val(currentUser.zip);

                $('.company_name').val(currentUser.company_name);
                $('.title').val(currentUser.title);

                $('#avatar').change(function() {
                    avatar_change = true;
                });
            }
        },

        'update_provider': {
            'href': '/update_provider',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }

                $.ajax({
                    url: 'http://backend.liquidtalent.com/get_info',
                    error: function (error) {
                        alert("Problem with connecting to the server");
                    }
                }).done(function (data) {
                    data['response']['categories'].forEach(function (item) {
                        $('#categories').append('<div onclick="setCategory(' + item['id'] + ', \'' + item['name'] + '\');">' + item['name'] + '</div>')

                        if(currentUser.category_id * 1 == item['id'] * 1) {
                            $('.category').val(item['name']);
                        }
                    })
                });

                $('.category').click(function () {
                    if($('#categories').is(':visible')) {
                        $('#categories').hide();
                    }
                    else {
                        $('#categories').show();
                    }
                });

                $('.years_in_industry').val(currentUser.years_in_industry);
                $('.description').val(currentUser.description);
                $('.skills').val(currentUser.skills);
                $('.hourly_rate').val(currentUser.hourly_rate);
                $('.portfolio').val(currentUser.portfolio);
                $('.experience').val(currentUser.experience);
                $('.summary').val(currentUser.summary);
                $('.school').val(currentUser.school_name);

                $('#category_id').val(currentUser.category_id);
                $('#school_id').val(currentUser.school_id);
            }
        },

        'terms': {
            'href': '/terms',
            'load': function () {
                if ($('#admin-panel')) { $('#admin-panel').removeClass('disabled'); }
                if ($('#background')) { $('#background').removeClass('disabled').css('overflow-y', 'scroll'); }
            }
        }

    };

    loaders = {

        'tags': $('.loader'),

        'toggle': function (loader, opacity) {

            loader = loaders.tags.each(function () {

                if ($(this).prop('alt') === loader) {
                    return $(this);
                }

            });
            loader.animate({ 'opacity': opacity }, 1000, 'linear');

        }

    };

    states = {
        'Alabama': 'AL',
        'Alaska': 'AK',
        'Arizona': 'AZ',
        'Arkansas': 'AR',
        'California': 'CA',
        'Colorado': 'CO',
        'Connecticut': 'CT',
        'Delaware': 'DE',
        'District Of Columbia': 'DC',
        'Florida': 'FL',
        'Georgia': 'GA',
        'Hawaii': 'HI',
        'Idaho': 'ID',
        'Illinois': 'IL',
        'Indiana': 'IN',
        'Iowa': 'IA',
        'Kansas': 'KS',
        'Kentucky': 'KY',
        'Louisiana': 'LA',
        'Maine': 'ME',
        'Maryland': 'MD',
        'Massachusetts': 'MA',
        'Michigan': 'MI',
        'Minnesota': 'MN',
        'Mississippi': 'MS',
        'Missouri': 'MO',
        'Montana': 'MT',
        'Nebraska': 'NE',
        'Nevada': 'NV',
        'New Hampshire': 'NH',
        'New Jersey': 'NJ',
        'New Mexico': 'NM',
        'New York': 'NY',
        'North Carolina': 'NC',
        'North Dakota': 'ND',
        'Ohio': 'OH',
        'Oklahoma': 'OK',
        'Oregon': 'OR',
        'Pennsylvania': 'PA',
        'Rhode Island': 'RI',
        'South Carolina': 'SC',
        'South Dakota': 'SD',
        'Tennessee': 'TN',
        'Texas': 'TX',
        'Utah': 'UT',
        'Vermont': 'VT',
        'Virginia': 'VA',
        'Washington': 'WA',
        'West Virginia': 'WV',
        'Wisconsin': 'WI',
        'Wyoming': 'WY',
        'American Samoa': 'AS',
        'Guam': 'GU',
        'Northern Mariana Islands': 'MP',
        'Puerto Rico': 'PR',
        'United States Minor Outlying Islands': 'UM',
        'Virgin Islands': 'VI',
        'Armed Forces Americas': 'AA',
        'Armed Forces Pacific': 'AP',
        'Armed Forces Others': 'AE'
    }

    $('#admin-panel .navigation .link').each(function (i, e) {

        $(e).on('mouseover', function (e) { ToggleNavigationHover(e); });
        $(e).on('mouseout', function (e) { ToggleNavigationHover(e); });

    });

    loadPage('home');

});

function ToggleNavigationHover (e) {

    if (!e) { e = $(window.event.currentTarget).find('.icon'); }
    else { e = $(e.currentTarget).find('.icon'); }

    if (/hover/.test($(e).prop('class'))) { $(e).removeClass('hover'); }
    else { $(e).addClass('hover'); }

}

function Response(response) {

    alert("Could not connect to the server. Please try again later.");
    console.log(response);

}

function loadPage(page) {

    if (currentUser === null) { $('.hiw').css({ display: 'none', opacity: 0 }); }
    else { $('.hiw').each(function (i, e) { $(e).removeAttr('style'); }); }

    Object.keys(pages).forEach(function (p) {
        if (pages[p].href === page.replace(/\?.+$/, '')) {
            pages.active = pages[p];
        }
    });

    /*
    if (page === '/login') {
        currentUser = prompt('Please enter your invitation code to proceed.', 'Invitation code');
        if (currentUser !== '01owmbau-wnr098bwi-3298571ns') {
            currentUser = null;
            setTimeout(function () { alert('The invitation code is either invalid or out of date.');}, 1200);
            return true;
        }
    }
    */

    if (pages.active !== '') {

        $('#content-preloader').show();

        $.ajax({
            url: page,
            error: Response
        }).done(function (data) {
            $('#content-preloader').hide();
            $('#background').html(data);
            pages.active.load();
        });

    }

    return false;

}

function getURLParameter(name) {
    return (decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1]).replace(/\+/g, '%20')) || null;
}

function createUser (data) {

    currentUser = data['response']['user'];
    showUserInfo();
    checkUnreadMessages();
    loadPage('/map');

    if (currentUser.avatar_url === null) { currentUser.avatar_url = <%= asset_path "new/main/avatar.png" %>; }

}

/***********************************************************************************************************************
/ Presentation
/**********************************************************************************************************************/

var rF;
var cF;
var pageSegments;

function SubmitRegisterForm() {

    $.ajax({
        url: rF.href,
        type: 'post',
        data: 'email=' + rF.e.val(),
        error: Response
    }).done(function (response) {

        if (response.success !== '') { alert(response.success); }
        else { alert(response.error); }

    });

}

function SubmitContactForm() {

    loaders.toggle('contact', 1);

    $.ajax({
        url: cF.href,
        type: 'post',
        data: 'name=' + cF.n.val() + '&email=' + cF.e.val() + '&message=' + cF.m.val(),
        error: Response
    }).done(function () {

        loaders.toggle('contact', 0);

    }).done(function (response) {

        if (response.success !== '') { alert(response.success); }
        else { alert(response.error); }

    });

}

function RevealPage(pageSegment) {

    pageSegments = {};
    $('.page-segment').each(function (i, e) {

        pageSegments[$(e).prop('title')] = $(e);

    });

    if (pageSegment === 'privacy') {

        Object.keys(pageSegments).forEach(function (page) {

            pageSegments[page].css({
                display: 'none',
                opacity: 0
            });

        });

        pageSegments.privacy.css('display', 'block').animate({ 'opacity': 1 }, 300, 'linear', null);

    }
    else {

        Object.keys(pageSegments).forEach(function (page) {

            pageSegments[page].css({
                display: 'block',
                opacity: 1
            });

        });

        pageSegments.privacy.animate({ 'opacity': 0 }, 300, 'linear', function () {
            pageSegments.privacy.css('display', 'none');
        });

    }

    $('html, body').delay(500).animate({ scrollTop: $(pageSegments[pageSegment]).offset().top }, 300, 'linear', null);

}

var sF;

/***********************************************************************************************************************
/ User
/**********************************************************************************************************************/

function login() {

    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com' + sF.href,
        data: 'email=' + sF.email.val() + '&password=' + sF.password.val()
    }).done(function (data) {

        if (data['status'] === 'failed') { alert(data['errors'][0]); }
        else {
            currentUser = data['response']['user'];
            showUserInfo();
            checkUnreadMessages();
            loadPage('/search');
        }

        $('#preloader').hide();

        getFavorites();

    });

}

function logout() {
    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/user/logout',
        data: 'user_id=' + currentUser.id + '&token=' + currentUser.token
    }).done(function (data) {
                if (data['status'] === 'failed') { alert(data['errors'][0]); }
                else {
                    currentUser = null;
                    loadPage('/home');
                    $('#preloader').hide();
                }
            });
}

/***********************************************************************************************************************
/ SignUp
/**********************************************************************************************************************/

function SubmitSignupForm() {
    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com' + sF.href,
        data: 'name=' + sF.n.val() + '&email=' + sF.e.val() + '&password=' + sF.p.val() + '&password_confirmation=' + sF.pc.val(),
        error: Response
    }).done(function (data) {
                if (data['status'] === 'failed') {
                    alert(data['errors'][0]);
                }
                else {
                    if (sF.as === true) {
                        $.ajax({
                            url: 'http://backend.liquidtalent.com/user/set_avatar',
                            type: 'POST',
                            contentType: false,
                            processData: false,
                            data: function () {
                                var rq_data = new FormData();
                                rq_data.append("user_id", data['response']['user']['id']);
                                rq_data.append("token", data['response']['user']['token']);
                                rq_data.append("avatar", sF.a.get(0).files[0]);
                                return rq_data;
                            }(),
                            error: Response
                        }).done(function (avatar_data) {
                                    if (avatar_data['status'] === 'failed') {
                                        alert(avatar_data['errors'][0]);
                                    }
                                    else {
                                        currentUser = data['response']['user'];
                                        currentUser['avatar_url'] = avatar_data['response']['url'];

                                        if ($('#is_provider').val() == 1) {
                                            loadPage('/signup_service_provider?user_id=' + data['response']['user']['id'] + '&token=' + data['response']['user']['token']);
                                        }
                                        else { createUser(data); }
                                    }

                                    $('#preloader').hide();
                                });

                    }
                    else {
                        if ($('#is_provider').val() == 1) {
                            loadPage('/signup_service_provider?user_id=' + data['response']['user']['id'] + '&token=' + data['response']['user']['token']);
                        }
                        else { createUser(data); }
                    }
                }

                $('#preloader').hide();
            });

    return false;

}

function SubmitSignupSPForm() {
    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com' + sF.href,
        data: 'user_id=' + $('#user_id').val() +
                '&token=' + $('#token').val() +
                '&attr[street]=' + sF.street.val() +
                '&attr[city_id]=' + $('#city_id').val() +
                '&attr[state]=' + sF.state.val() +
                '&attr[zip]=' + sF.zip.val() +
                '&attr[description]=' + sF.description.val() +
                '&attr[summary]=' + sF.summary.val() +
                '&attr[hourly_rate]=' + sF.hourly_rate.val() +
                '&attr[experience]=' + sF.experience.val() +
                '&attr[category_id]=' + $('#category_id').val() +
                '&attr[school_id]=' + $('#school_id').val() +
                '&attr[is_provider]=1',
        error: Response
    }).done(function (data) {
                if (data['status'] === 'failed') {
                    alert(data['errors'][0]);
                }
                else { createUser(data); }

                $('#preloader').hide();
            });

}

function searchSchool(query) {

    if (query === '') {
        $('#schools').html('');
        return;
    }

    $.ajax({
        url: 'http://backend.liquidtalent.com/schools/search?search=' + query,
        error: Response
    }).done(function (data) {
                $('#schools').show();
                $('#schools').html('');

                data['response'].forEach(function (school) {
                    $('#schools').append('<div onclick="setSchool(' + school['_source']['id'] + ', \'' + school['_source']['name'] + '\');">' + school['_source']['name'] + '</div>')
                })
            });
}

function setCategory(id, name) {
    $('.category').val(name);
    $('#category_id').val(id);

    filter_settings.category.label = name;
    filter_settings.category.value = id;

    $('#categories').hide();

    $('.subcategory').val('Subcategories');
    $('#subcategories').html('');

    if(id == null) {
        $('#subcategory_id').val(null);
    }

    global_info['sub_categories'].forEach(function (item) {
        if(item['parent_id'] == id) {
            $('#subcategories').append('<div onclick="setSubcategory(' + item['id'] + ', \'' + item['name'] + '\');">' + item['name'] + '</div>');
            filter_settings.subcategories.push({label: item['name'], value: item['id']});
        }
    });
}

function setSubcategory(id, name) {
    $('.subcategory').val(name);
    $('#subcategory_id').val(id);

    filter_settings.subcategory.label = name;
    filter_settings.subcategory.value = id;

    $('#subcategories').hide();
}

function setCity(id, name) {
    $('.city').val(name);
    $('#city_id').val(id);

    filter_settings.city.label = name;
    filter_settings.city.value = id;

    $('#cities').hide();
}

function setSkills(id, name) {

    $('.skills').val(name);
    $('#category_id').val(id);

    $('#skills').hide();
}

function setState(id, name) {

    $('.state').val(name);
    $('#state_id').val(id);

    $('#states').html('');
}

function setSchool(id, name) {
    $('.school').val(name);
    $('#school_id').val(id);

    filter_settings.college.label = name;
    filter_settings.college.value = id;

    $('#schools').html('');
}

function show_user(user_id, callback) {
    $.ajax({
        url: 'http://backend.liquidtalent.com/user/show?user_id=' + user_id,
        error: Response
    }).done(function (data) {
                return callback(data);
            });
}

function linkedin_connect(access_token) {
    $.ajax({
        url: 'http://backend.liquidtalent.com/user/linkedin_connect/?access_token=' + access_token,
        error: Response
    }).done(function (data) {
                if (data['response']['new_user']) {
                    if (confirm('Do you want to register as a Service Provider?')) {
                        loadPage('/signup_service_provider?user_id=' + data['response']['user']['id'] + '&token=' + data['response']['user']['token']);
                    } else { createUser(data); }

                    $('#preloader').hide();
                }
                else { createUser(data); }

                $('#preloader').hide();
            });
}

function logout() {
    current_user = false;
    window.location = '/'

    return false;
}

/****** Search ******/

var map, states, list;

function mapSearch(providers) {
    map = $('#map-overlay');
    map = {

        'markers': [],

        'googleMap': new google.maps.Map( document.getElementById('map'), {
            center: new google.maps.LatLng(40.5403, -73.5463),
            zoom: 8,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        }),

        'popUp': {
            'overlay': $('#map-overlay'),
            'image': map.find('.avatar'),
            'description': map.find('.description'),
            'distance': map.find('.distance'),
            'linkedIn': map.find('.linkedin-icon'),
            'title': map.find('.base .title'),
            'favorite': map.find('.favorite-button'),
            'play': map.find('.play-button'),
            'LTDrop': map.find('.lt-drop'),
            'stars': map.find('.stars .star')
        }

    };

    map.popUp.overlay.on('click', function (event) {
        if ($(event.target).prop('id') === 'map-overlay') {
            map.popUp.overlay.animate({ opacity: 0 }, 1000, 'linear').promise().done(function () {
                map.popUp.overlay.css('display', 'none');
            });
        }
    });

    $('#content-preloader').hide();

    providers.forEach(function (user) {

            map.markers[user.id] = new google.maps.Marker({

                position: new google.maps.LatLng(user.latitude, user.longitude),
                map: map.googleMap,
                title: user.name,
                icon: '<%= asset_path 'search/pin.png' %>'

            });

            google.maps.event.addListener(map.markers[user.id], 'click', function () {

                if (user.state !== undefined) { user.state = (user.state.length > 2)? states[user.state] : user.state.toUpperCase(); }
                else { user.state = 'NY'; }

                map.popUp.LTDrop.removeClass('hidden').removeClass('blue').removeClass('bronze').removeClass('silver').removeClass('gold');

                if (typeof (favorites[user.id]) === 'number') { map.popUp.favorite.addClass('active'); }
                else { map.popUp.favorite.removeClass('active'); }
                map.popUp.favorite.attr('onmousedown', 'createFavorite(' + user.id + ', $(this));');

                map.popUp.image.attr('onclick', 'profileId=' + user.id + '; back="map"; loadPage("/profile");');
                map.popUp.title.attr('onclick', 'profileId=' + user.id + '; back="map"; loadPage("/profile");');

                map.popUp.play.attr('onclick', 'playVideo();');

                user.avatar_url = (user.avatar_url === null) ? '<%= asset_path 'new/main/avatar.png' %>' : user.avatar_url;

                if (user.badge === 'no') { map.popUp.LTDrop.addClass('hidden'); }
                else { map.popUp.LTDrop.addClass(user.badge); }

//                if (user.video_url === null) { map.popUp.play.addClass('disabled'); }
//                else { map.popUp.play.removeClass('disabled'); }

                map.popUp.stars.each(function (i, star) {

                    if (i < user.rate_provider) { $(star).addClass('active'); }
                    else { $(star).removeClass('active'); }

                });

                map.popUp.overlay.css('display', 'block').animate({ opacity: 1 }, 1000, 'linear');
                map.popUp.image.prop('src', user.avatar_url);
                map.popUp.description.html(user.description);
                map.popUp.title.html('<p class="name">' + user.name + '</p>' + user.city_name + ', ' + user.state);

                map.popUp.distance.html('$' + user.hourly_rate + '.00');

            });

        });

}

function listSearch(providers) {
    $('#providers').html('');

    providers.forEach(function (user) {

        user.hourly_rate = calculateCost(user.hourly_rate);

        if (user.state !== undefined) { user.state = (user.state.length > 2)? states[user.state] : user.state.toUpperCase(); }
        else { user.state = 'NY'; }

        user.avatar_url = (user.avatar_url === null) ? '<%= asset_path 'new/main/avatar.png' %>' : user.avatar_url;

        $('#first-item .avatar').attr('src', user.avatar_url);
        $('#first-item .play-button').attr('onclick', 'playVideo();');

        $('#first-item .avatar').attr('onclick', 'profileId=' + user.id + '; back="search"; loadPage("/profile");');
        $('#first-item .title').attr('onclick', 'profileId=' + user.id + '; back="search"; loadPage("/profile");');

        if (user.badge === 'no') { $('#first-item .lt-drop').addClass('hidden'); }
        else { $('#first-item .lt-drop').addClass(user.badge); }

//            if (user.video_url === null) { $('#first-item .play-button').addClass('disabled'); }
//            else { $('#first-item .play-button').removeClass('disabled'); }

        $('#first-item .title').html('<p class="name">' + user.name + '</p>' + user.city_name + ', ' + user.state);
        $('#first-item .description').html(user.description);

        $('#first-item .distance').html(user.hourly_rate);

        if (typeof (favorites[user.id]) === 'number') { $('#first-item .favorite-button').addClass('active'); }
        else { $('#first-item .favorite-button').removeClass('active'); }
        $('#first-item .favorite-button').attr('onmousedown', 'createFavorite(' + user.id + ', $(this));');

        $('#providers').append('<div class="list-item">' + $('#first-item').clone().html() + '</div>');

    });
}

function showUserInfo() {

    currentUser['state'] = checkState(currentUser['state']);
    currentUser['city_name'] = (!currentUser['city_name'])? 'New York' : currentUser['city_name'];

    var avatar = currentUser['avatar_url'] ? currentUser['avatar_url'] : '<%= asset_path '/assets/new/main/avatar.png' %>';

    $('#admin-panel .header .login').hide();
    $('#user-info').show();

    $('#user-info .avatar').attr('src', avatar);
    $('#user-info .name').html(currentUser['name']);
    $('#user-info .location').html(currentUser['city_name'] + ', ' + currentUser['state']);
}

function createFavorite(userID, button) {

    if (currentUser !== null) {

        if (/active/.test(button.prop('class'))) { destroyFavorite(userID, button); }
        else {

            button.addClass('active');

            $.ajax({
                url: 'http://backend.liquidtalent.com/favourite/create?token=' + currentUser.token + '&demander_id=' + currentUser.id + '&provider_id=' + userID,
                error: Response
            }).done(function (user) {

                if (user.status === 'ok') { favorites[user.provider_id] = user.id; }

            });

        }

    }
    else {

        loadPage('/login');

    }

}
function destroyFavorite(userID, button) {

        button.removeClass('active');

        $.ajax({
            url: 'http://backend.liquidtalent.com/favourite/destroy?token=' + currentUser.token + '&favourite_id=' + favorites[userID],
            error: Response
        }).done(function (user) {

            if (user.status === 'ok') { favorites.splice(indexOf(favorites[userID]), 1); }

        });

}
function getFavorites() {

    if (currentUser.token !== null) {

        $.ajax({
            url: 'http://backend.liquidtalent.com/favourites/list?token=' + currentUser.token + '&demander_id=' + currentUser.id,
            error: Response
        }).done(function (users) {

            favorites = [];
            users.response.forEach(function (user) { favorites[user.provider.id] = user.favourite_id; });

        });

    }

}

function filterUsers(callback) {
    $('#filter').hide();
    $('#content-preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/users/filter',
        data: 'category_id=' + $('#category_id').val() +
              '&subcategory_id=' + $('#subcategory_id').val() +
              '&city_id=' + $('#subcategory_id').val() +
              '&hourly_rate_from=' + $('#hourly_rate_from').val() +
              '&hourly_rate_to=' + $('#hourly_rate_to').val() +
              '&rate_from=' + $('#rate_from').val() +
              '&rate_to=' + $('#rate_to').val() +
              '&school_id=' + $('#subcategory_id').val(),
        error: Response
    }).done(function (data) {
        $('#content-preloader').hide();
        users = data['response'];
        callback(users);
    });

    return false;
}

function prepareFilter() {
    $.ajax({
        url: 'http://backend.liquidtalent.com/get_info',
        error: function (error) {
            alert("Problem with connecting to the server");
            console.log(error);
        }
    }).done(function (data) {
        global_info = data['response'];

        data['response']['cities'].forEach(function (item) {
            $('#cities').append('<div onclick="setCity(' + item['id'] + ', \'' + item['name'] + '\');">' + item['name'] + '</div>')
        })

        data['response']['categories'].forEach(function (item) {
            $('#categories').append('<div onclick="setCategory(' + item['id'] + ', \'' + item['name'] + '\');">' + item['name'] + '</div>')
        })
    });

    $('.city').click(function () {
        if($('#cities').is(':visible')) {
            $('#cities').hide();
        }
        else {
            $('#cities').show();
        }
    });

    $('.category').click(function () {
        if($('#categories').is(':visible')) {
            $('#categories').hide();
        }
        else {
            $('#categories').show();
        }
    });

    $('.subcategory').click(function () {
        if($('#subcategories').is(':visible')) {
            $('#subcategories').hide();
        }
        else {
            $('#subcategories').show();
        }
    });

    if(filter_settings.subcategories.length > 0) {
        $('#subcategories').html('<div onclick="setSubcategory(null, \'All Subcategories\');">All Subcategories</div>');
    }

    filter_settings.subcategories.forEach(function (item) {
        $('#subcategories').append('<div onclick="setSubcategory(' + item.value + ', \'' + item.label + '\');">' + item.label + '</div>');
    });

    $( "#hourly_rate" ).slider({range: true, min: 0, max: 200, step: 20, values: [filter_settings.hourly_rate_from.value, filter_settings.hourly_rate_to.value],
        change: function( event, ui ) {
            var hourly_rate_values = $( "#hourly_rate" ).slider('values');
            $('#hourly_rate_from').val(hourly_rate_values[0]);
            $('#hourly_rate_to').val(hourly_rate_values[1]);

            filter_settings.hourly_rate_from.label = filter_settings.hourly_rate_from.value = hourly_rate_values[0];
            filter_settings.hourly_rate_to.label = filter_settings.hourly_rate_to.value = hourly_rate_values[1];
        },
        slide: function( event, ui ) {
            $('#hourly_rate_from_label').html(ui.values[0]);
            $('#hourly_rate_to_label').html(ui.values[1]);
        }
    });

    $( "#rate" ).slider({range: true, min: 0, max: 5, step: 1, values: [filter_settings.rate_from.value, filter_settings.rate_to.value],
        change: function( event, ui ) {
            var rate_values = $( "#rate" ).slider('values');
            $('#rate_from').val(rate_values[0]);
            $('#rate_to').val(rate_values[1]);

            filter_settings.rate_from.label = filter_settings.rate_from.value = rate_values[0];
            filter_settings.rate_to.label = filter_settings.rate_to.value = rate_values[1];
    },
        slide: function( event, ui ) {
            $('#rate_from_label').html(ui.values[0]);
            $('#rate_to_label').html(ui.values[1]);
        }
    });

    $('.category').val(filter_settings.category.label);
    $('.subcategory').val(filter_settings.subcategory.label);
    $('.city').val(filter_settings.city.label);
    $('.college').val(filter_settings.college.label);

    $('#category_id').val(filter_settings.category.value);
    $('#subcategory').val(filter_settings.subcategory.value);
    $('#city').val(filter_settings.city.value);
    $('#college').val(filter_settings.college.value);
    $('#hourly_rate_from').val(filter_settings.hourly_rate_from.value);
    $('#hourly_rate_to').val(filter_settings.hourly_rate_to.value);
    $('#rate_from').val(filter_settings.rate_from.value);
    $('#rate_to').val(filter_settings.rate_to.value);
}

function showPlaceholder (page) {

    if (currentUser === null) {

        $('#background').html(

            '<div id="placeholder">' +
                'Explore all of LiquidTalent.' +
                '<a href="javascript:loadPage(\'/login\')" class="green-button">Sign Up</a>' +
            '</div>'

        );

    }
    else {

        $('#background').html(

            '<div id="placeholder">' +
                'No ' + page + ' have been added here yet.' +
                '<a href="javascript:loadPage(\'/map\')" class="green-button">Find ' + page + '</a>' +
            '</div>'

        );

    }

}

function userMenu() {
    if($('#user-menu').is(':visible')) {
        $('#user-menu').hide();
    }
    else {
        $('#user-menu').show();
    }

    return false;
}

/***** Messages *****/

function checkUnreadMessages() {

    var notification = $('.navigation .messages .notification');

    $.ajax({
        url: 'http://backend.liquidtalent.com/messages/list?user_id=' + currentUser['id'],
        error: Response
    }).done(function (data) {

        if (typeof (data['response']) !== 'undefined' &&
            typeof (data['response'][0]) !== 'undefined') {

            notification.addClass('active');
            notification.html('0');

            for (var i = 0; i < data['response'].length; i++) {

                messages[i] = data['response'][i];

                if (data['response'][i].unread_messages > 0) {
                    notification.html(parseInt(notification.html(), 0) + data['response'][i].unread_messages);
                }

            }

            if (parseInt(notification.html(), 0) === 0) { notification.removeClass('active'); }

        }
        else { notification.removeClass('active'); }

    });

    setTimeout(checkUnreadMessages, 10000);

}

function loadMessages() {

    if (messages.length === 0) { showPlaceholder('Messages'); }
    else {

        $('#background').html(
            '<div id="title">' +
                'Messages' +
                '<a class="black-button" href="#">Edit</a>' +
            '</div>'
        );

        for (var i = 0; i < messages.length; i++) {

            $('#background').html($('#background').html() +
                '<div id="' + messages[i].sender.id + '" class="message-user">' +
                    '<div class="green-button' + ((messages[i].unread_messages > 0) ? ' active' : '') + '">' + messages[i].unread_messages + '</div>' +
                    '<a href="javascript:blockUser(' + messages[i].sender.id + ');" class="black-button t">x</a>' +
                    '<img class="avatar" src="' + ((messages[i].avatar_url === undefined) ? '<%= asset_path "new/main/avatar.png" %>' : messages[i].sender.avatar_url) + '" alt="User Avatar">' +
                    '<div class="name">' + messages[i].sender.name + '</div>' +
                '</div>'
            );

        }

    }
    $('#background #title .black-button').on('mouseup', function () {

        $('.message-user .black-button').each(function (i, e) {

            if (/active/.test($(e).prop('class'))) { $(e).removeClass('active'); }
            else { $(e).addClass('active'); }

        });

    });

    $('.message-user').each(function (i, e) {

        $(this).on('mouseup', function () { loadChat($(this).prop('id')); });

    });

}

function blockUser(user_id) {

    $.ajax({
        url: 'http://backend.liquidtalent.com/messages/block_user?user_id=' + currentUser.id + '&blocked_user_id=' + user_id,
        error: Response
    }).done(function (data) {

        messages = $.grep(messages, function (value) {

            return value.sender.id != user_id;

        });

        $('#' + user_id).remove();

    });

}

function loadChat(user_id) {

    $.ajax({
        url: 'http://backend.liquidtalent.com/nda/show?user_id_1=' + currentUser.id + '&user_id_2=' + user_id,
        error: Response
    }).done(function (nda) {

        nda = nda.response;

        $('#background').html(
            '<div id="title">' +
                    ((nda.length === 0) ?
                        '<a href="javascript:sendNDA();" class="green-button t">Send NDA</a>'
                        :
                        '<b>NDA</b> sent on ' + nda.created_at.toJSON().replace(/\d{2}(\d{2})-(\d{2})-\d{2}T\d{2}\:\d{2}\:\d{2}.\d{3}Z/, '$2/$3/$1')
                    ) +
                'Messages' +
                '<a class="black-button" href="#">Back</a>' +
            '</div>'
        );

    });

    $('#background').html($('#background').html() +
        '<div id="chat"></div>' +
        '<textarea placeholder="Message" id="chat-box"></textarea>' +
        '<a href="javascript:createChat(' + user_id + ');" class="green-button" id="create-chat">Create</a>'
    );

    $('.message-user').each(function () { $(this).remove(); });

    $('#background #title .black-button').on('mouseup', function () { loadMessages(); });
    $('#background #title .green-button').addClass('active');

    $.ajax({
        url: 'http://backend.liquidtalent.com/messages/conversation?user_id_1=' + currentUser.id + '&user_id_2=' + user_id,
        error: Response
    }).done(function (chat) {

        chat = chat.response;

        for (var i = 0, date; i < chat.length; i++) {

            $.ajax({
                url: 'http://backend.liquidtalent.com/messages/viewed?sender_id=' + chat[i].message.sender_id + '&receiver_id=' + chat[i].message.receiver_id + '&ts=' + chat[i].message.ts,
                error: Response
            }).done(function(){});

            //date = new Date(chat[i].message.ts).toJSON().replace(/\d{2}(\d{2})-(\d{2})-(\d{2})T(\d{2}\:\d{2})\:\d{2}.\d{3}Z/, '$2/$3/$1 $4');
            date = chat[i].message.created_at.replace(/\d{2}(\d{2})-(\d{2})-(\d{2})T(\d{2}\:\d{2})\:\d{2}.\d{3}Z/, '$2/$3/$1 $4');

            $('#chat').prepend(

                '<div class="chat-box">' +
                    '<div class="title">' +
                        '<img src="' + ((chat[i].sender.avatar_url === null) ? '<%= asset_path "new/main/avatar.png" %>' : chat[i].sender.avatar_url) + '" alt="User Avatar" class="avatar">' +
                        '<div class="date">' + date + '</div>' +
                        '<div class="name">' + chat[i].sender.name + '</div>' +
                    '</div>' +
                    '<div class="chat">' + chat[i].message.contents + '</div>' +
                '</div>'

            );

        }

    });

}

function createChat (user_id) {

    var date = new Date();

    $.ajax({
        url: 'http://backend.liquidtalent.com/message/create?' +
                'token=' + currentUser.token +
                '&sender_id=' + currentUser.id +
                '&receiver_id=' + user_id +
                '&contents=' + $('#chat-box').val() +
                '&created_at=' + Math.floor(date / 1000),
        error: Response
    }).done(function (chat) {

        if(chat.status === 'failed') { alert(errors[0]); }
        else {

            date = date.toJSON().replace(/\d{2}(\d{2})-(\d{2})-(\d{2})T(\d{2}\:\d{2})\:\d{2}.\d{3}Z/, '$2/$3/$1 $4');

            $('#chat').html($('#chat').html() +

                '<div class="chat-box">' +
                    '<div class="title">' +
                        '<img src="' + currentUser.avatar_url + '" alt="User Avatar" class="avatar">' +
                        '<div class="date">' + date + '</div>' +
                        '<div class="name">' + currentUser.name + '</div>' +
                    '</div>' +
                    '<div class="chat">' + $('#chat-box').val() + '</div>' +
                '</div>'

            );

        }

    });

}

function sendNDA () {

    $('#title .green-button').remove();

}

/***** Favorites *****/

function checkState (state) {
    if (state) { state = (state.length > 2)? states[state] : state.toUpperCase(); }
    else { state = 'NY'; }

    return state;
}

function loadFavorites() {
    if(currentUser === null) {
        showPlaceholder('Favorites');
        return false;
    }

    $('#content-preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/favourites/list',
        data: 'demander_id=' + currentUser['id'] +
                '&token=' + currentUser['token'] +
                '&offset=0' +
                '&limit=999',
        error: Response
    }).done(function (data) {
        $('#content-preloader').hide();

        data['response'].forEach(function (item) {
            user = item['provider'];

            user.hourly_rate = calculateCost(user.hourly_rate);
            user.state = checkState(user.state);

            user.avatar_url = (user.avatar_url === null) ? '<%= asset_path 'new/main/avatar.png' %>' : user.avatar_url;

            $('#first-item .avatar').attr('src', user.avatar_url);

            $('#first-item .avatar').attr('onclick', 'profileId=' + user.id + '; back="favorites"; loadPage("/profile");');
            $('#first-item .title').attr('onclick', 'profileId=' + user.id + '; back="favorites"; loadPage("/profile");');

            if (user.badge === 'no') { $('#first-item .lt-drop').addClass('hidden'); }
            else { $('#first-item .lt-drop').addClass(user.badge); }

//          if (user.video_url === null) { $('#first-item .play-button').addClass('disabled'); }
//          else { $('#first-item .play-button').removeClass('disabled'); }

            $('#first-item .title').html('<p class="name">' + user.name + '</p>' + user.city_name + ', ' + user.state);
            $('#first-item .description').html(user.description);

            $('#first-item .distance').html(user.hourly_rate);

            if (typeof (favorites[user.id]) === 'number') { $('#first-item .favorite-button').addClass('active'); }
            else { $('#first-item .favorite-button').removeClass('active'); }
            $('#first-item .favorite-button').attr('onmousedown', 'createFavorite(' + user.id + ', $(this));');

            $('#first-item .removeFavorite').attr('id', item['favourite_id']);

            $('#first-item .message').attr('onclick', 'back="favorites"; loadChat(' + user.id + ');');
            $('#first-item .hire').attr('onclick', 'back="favorites"; providerId=' + user.id + '; loadPage("/hire");');

            $('#providers').append('<div class="list-item">' + $('#first-item').clone().html() + '</div>');

        });

        $('.list-item .base .removeFavorite').on('click', function() {
            if(confirm('Do you really want to remove this favorited provider?')) {
                removeFavorite($(this).prop('id'));
            }
        });

    });

    return false;
}

function removeFavorite(favourite_id) {
    $('#content-preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/favourite/destroy?token=' + currentUser.token + '&favourite_id=' + favourite_id,
        error: Response
    }).done(function (user) {
        $('#content-preloader').hide();

        if (user.status === 'ok') {
            $('#' + favourite_id).parents('.list-item').html('');
        }

    });
}

function ToggleFavoriteDelete () {

    $('.removeFavorite').css('display', $('.removeFavorite').css('display') === 'block' ? 'none' : 'block');

}

function loadStats(term) {
    if(currentUser == null) {
        showPlaceholder('Stats');
        return false;
    }

    $('#content-preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/stats/show?user_id=' + currentUser.id + '&token=' + currentUser.token + '&timeframe=' + term,
        error: Response
    }).done(function (user) {
        if (user.status === 'ok') {
            var total = user['response']['paid'] + user['response']['unpaid'];

            $('#current-balance').html('$' + (total - user['response']['paid']));
            $('#total-earnings').html('$' + total);

            if(currentUser.is_provider) {
                $('.drp').addClass('dropimg-provider');
                $('#current-projects').html(user['response']['provided_bookings_current']);
                $('#completed-projects').html(user['response']['provided_bookings_completed']);
            }
            else {
                $('.drp').addClass('dropimg-demander');
                $('#current-projects').html(user['response']['demanded_bookings_current']);
                $('#completed-projects').html(user['response']['demanded_bookings_completed']);
                $('#earnings-chart').siblings('.title').html('Payments');
            }


            var drop_total = 0;
            var drop_name = '';

            if(total < 1000) {
                drop_total = 1000 - total;
                drop_name = 'blue';
                $('#drop1 > div.bar ').css('backgroundPosition', Math.round((89 - 89 * (drop_total / 1000)) - 89) + 'px 0px');
            }
            else if(total < 5000) {
                drop_total = 5000 - total;
                drop_name = 'bronze';
                $('#drop1 > div.bar ').css('backgroundPosition', '90px 0px');
                $('#drop2 > div.bar ').css('backgroundPosition', Math.round((89 - 89 * (drop_total / 5000)) - 89) + 'px -19px');
            }
            else if(total < 10000) {
                drop_total = 10000 - total;
                drop_name = 'silver';
                $('#drop1 > div.bar ').css('backgroundPosition', '0px 0px');
                $('#drop2 > div.bar ').css('backgroundPosition', '0px -19px');
                $('#drop3 > div.bar ').css('backgroundPosition', Math.round((89 - 89 * (drop_total / 10000)) - 89) + 'px -38px');
            }
            else if(total < 25000) {
                drop_total = 25000 - total;
                drop_name = 'gold';
                $('#drop1 > div.bar ').css('backgroundPosition', '0px 0px');
                $('#drop2 > div.bar ').css('backgroundPosition', '0px -19px');
                $('#drop3 > div.bar ').css('backgroundPosition', '0px -38px');
                $('#drop4 > div.bar ').css('backgroundPosition', Math.round((89 - 89 * (drop_total / 25000)) - 89) + 'px -57px');
            }
            else {
                drop_total = null;
            }

            if(drop_total == null) {
                $('#dew-drops').hide();
            }
            else {
                $('#drop-total').html(drop_total);
                $('#drop-name').html(drop_name);
            }

            var bookings = [];
            var earnings = [];
            var favourites = [];
            var profile_views = [];
            var video_views = [];

            user['response']['stats'].forEach(function(item) {
                if(currentUser.is_provider) {
                    bookings.push([item['date'] * 1000, item['provided_bookings']]);
                    earnings.push([item['date'] * 1000, item['earnings']]);
                    favourites.push([item['date'] * 1000, item['favourited_by_demanders']]);
                }
                else {
                    bookings.push([item['date'] * 1000, item['demanded_bookings']]);
                    earnings.push([item['date'] * 1000, item['payments']]);
                    favourites.push([item['date'] * 1000, item['favourited_providers']]);
                }
                profile_views.push([item['date'] * 1000, item['profile_views']]);
                video_views.push([item['date'] * 1000, item['video_views']]);
            });

            chart_options.series[0].data = bookings;
            new Highcharts.Chart(chart_options);

            chart_options.chart.renderTo = 'earnings-chart';
            chart_options.series[0].data = earnings;
            new Highcharts.Chart(chart_options);

            chart_options.chart.renderTo = 'favourites-chart';
            chart_options.series[0].data = favourites;
            new Highcharts.Chart(chart_options);

            chart_options.chart.renderTo = 'profile-views-chart';
            chart_options.series[0].data = profile_views;
            new Highcharts.Chart(chart_options);

            chart_options.chart.renderTo = 'video-views-chart';
            chart_options.series[0].data = video_views;
            new Highcharts.Chart(chart_options);

            $('#content-preloader').hide();
        }

    });
}

function setStatsTerm(term, name) {
    $('#term-selector').html(name);
    $('#term-selector-options').hide();

    loadStats(term);
}

function loadProfile() {
    $('#content-preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/user/show?user_id=' + profileId,
        error: Response
    }).done(function (user) {
        user = user['response']['user'];

        $('#content-preloader').hide();

        if (user.state !== undefined) { user.state = (user.state.length > 2)? states[user.state] : user.state.toUpperCase(); }
        else { user.state = 'NY'; }

        user.avatar_url = (user.avatar_url === null) ? '<%= asset_path 'new/main/avatar.png' %>' : user.avatar_url;

        $('#first-item .avatar').attr('src', user.avatar_url);

        if (user.badge === 'no') { $('#first-item .lt-drop').addClass('hidden'); }
        else { $('#first-item .lt-drop').addClass(user.badge); }

    //            if (user.video_url === null) { $('#first-item .play-button').addClass('disabled'); }
    //            else { $('#first-item .play-button').removeClass('disabled'); }

        $('#first-item .title').html('<p class="name">' + user.name + '</p>' + user.city_name + ', ' + user.state);
        $('#first-item .description').html(user.description);

        $('#first-item .distance').html('$' + user.hourly_rate + '.00');

        if (typeof (favorites[user.id]) === 'number') { $('#first-item .favorite-button').addClass('active'); }
        else { $('#first-item .favorite-button').removeClass('active'); }
        $('#first-item .favorite-button').attr('onmousedown', 'createFavorite(' + user.id + ', $(this));');

        if(user.is_provider) {
            $('#profile-provider').show();
            $('#profile-demander').hide();

            $('#profile-skills').html(user.skills);
            $('#profile-summary').html(user.summary);
            $('#profile-experience').html(user.experience);
            $('#profile-education').html(user.school_name);

            $('.hire-button-profile').attr('onclick', 'back="profile"; providerId=' + user.id + '; loadPage("/hire");');
        }
    });
}

function calculateCost (rate) {

    if (rate > 1) { rate = 1; }
    if (rate > 15) { rate = 2; }
    if (rate > 25) { rate = 3; }
    if (rate > 75) { rate = 4; }
    if (rate > 200) { rate = 5; }

    switch (rate) {

        case 1: rate = '$'; break;
        case 2: rate = '$$'; break;
        case 3: rate = '$$$'; break;
        case 4: rate = '$$$$'; break;
        case 5: rate = '$$$$$'; break;

    }

    return rate;

}

/***** Video *****/

function uploadVideo() {
    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/user/set_video',
        type: 'POST',
        contentType: false,
        processData: false,
        data: function () {
            var rq_data = new FormData();
            rq_data.append("user_id", currentUser.id);
            rq_data.append("token", currentUser.token);
            rq_data.append("video", $('#video').get(0).files[0]);
            return rq_data;
        }(),
        error: Response
    }).done(function (data) {
        if (data['status'] === 'failed') {
            alert(data['errors'][0]);
        }
        else {
            currentUser['video_url'] = data['response']['url'];
            alert('The video has been successfully uplaoded!');
        }

        $('#preloader').hide();
    });
}

function playVideo() {
    $('#preloader').show();

    $.ajax({
        url: '/video',
        error: Response
    }).done(function (data) {
        $('#background').append(data);

        jwplayer("player").setup({
            wmode: "transparent",
            file: currentUser.video_url,
            provider:'http',
            autostart: true,
            height: 510,
            skin: 'roundster',
            width: 660,
            controlbar: 'bottom'

        });

        $('#preloader').hide();
    });
}

/***** Hire *****/

function loadHire() {
    if(currentUser == null) {
        showPlaceholder('Job');
        return false;
    }

    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/user/show?user_id=' + providerId,
        error: Response
    }).done(function (user) {
        $('#avatar').attr('src', user['response']['user']['avatar_url']);
        $('#hire-title').html(user['response']['user']['name']);

        $('#preloader').hide();
    });
}

function submitBooking() {
    booking.budget   = $('.budget').val();
    booking.due_date = $('.due-date').val();
    booking.description = $('.description').val();

    loadPage('/hire_confirm');
}

function confirmBooking() {
    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/booking/create?' +
                'token=' + currentUser.token +
                '&demander_id=' + currentUser.id +
                '&provider_id=' + providerId +
                '&budget=' + booking.budget +
                '&due_date=' + (new Date(Date.parse(booking.due_date)).getTime() / 1000) +
                '&description=' + booking.description +
                '&stripe_token=' + $('#stripeToken').val() +
                '&ica_sent=0',
        error: Response
    }).done(function (data) {
                if (data['status'] == 'failed') {
                    alert(data['errors'][0]);
                    $('#preloader').hide();
                }
                else {
                    alert('The new project has been successfully created');
                    loadPage('/projects');
                }


            });
}

function loadProjects() {
    if(currentUser == null) {
        showPlaceholder('Projects');
        return false;
    }

    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/bookings/list_all_bookings?' +
            'token=' + currentUser.token +
            '&user_id=' + currentUser.id,
        error: Response
    }).done(function (data) {
        if (data['status'] === 'failed') {
            alert(data['errors'][0]);
        }
        else {
            var user = null, userType = null;

            data.response.forEach(function(item) {
                bookings[item.booking.id] = item;

                if(item.booking.status != 'rejected') {
                    if(item.demander.id == currentUser.id) {
                        user = item.provider;
                        userType = 'demander';
                    }
                    else {
                        user = item.demander;
                        userType = 'provider'
                    }

                    $('#first-project .avatar').attr('src', user.avatar_url ? user.avatar_url : '<%= asset_path "new/main/avatar.png" %>');
                    $('#first-project .name').html(user.name);

                    dueDate = new Date(item.booking.due_date * 1000);

                    $('#first-project .due-date').html((dueDate.getMonth() + 1) + '/' + dueDate.getDate() + '/' + dueDate.getFullYear());
                    $('#first-project .description').html(item.booking.description);
                    $('#first-project .total-amount').html(item.booking.budget);

                    $('#first-project .budget').show();
                    $('#first-project .status').hide();

                    if(userType == 'demander') {
                        if(item.booking.status == 'confirmed') {
                            $('#first-project .status.pending').show();
                        }
                        else if(item.booking.status == 'in_progress' || item.booking.status == 'accepted') {
                            $('#first-project .status.complete').show();
                            $('#first-project .status.complete').attr('onclick', 'bookingId=' + item.booking.id + '; loadPage("/rate");');
                        }
                        else if(item.booking.status == 'completed') {
                            $('#first-project .budget').hide();
                            $('#first-project .status.completed-demander').show();
                        }
                        else if(item.booking.status == 'pending') {
                            $('#first-project .status.pending').show();
                        }
                    }
                    else {
                        if(item.booking.status == 'confirmed') {
                            $('#first-project .status.accept-decline').show();
                            $('#first-project .status-btn.accept').attr('onclick', 'bookingId=' + item.booking.id + '; loadPage("/hire_accept");');
                            $('#first-project .status-btn.decline').attr('onclick', 'bookingId=' + item.booking.id + '; if(confirm("Do you really want to reject this projects?")) rejectBooking();');
                        }
                        else if(item.booking.status == 'in_progress' || item.booking.status == 'accepted') {
                            $('#first-project .status.in-progress').show();
                        }
                        else if(item.booking.status == 'completed') {
                            $('#first-project .budget').hide();
                            $('#first-project .status.completed-provider').show();

                        }
                        else if(item.booking.status == 'pending') {
                            $('#first-project .status.pending').show();
                        }
                    }

                    $('#projects').append('<div class="project">' + $('#first-project').clone().html() + '</div>');
                }
            });
        }

        $('#preloader').hide();
    });
}

function loadRate() {
    $('#rate').hide();
    $('#preloader').show();

    if(bookings[bookingId].demander.id == currentUser.id) {
        user = bookings[bookingId].provider;
    }
    else {
        user = bookings[bookingId].demander;
    }

    $('#rate .avatar').attr('src', user.avatar_url ? user.avatar_url : '<%= asset_path "new/main/avatar.png" %>');
    $('#rate .name').html(user.name);

    $('.total-amount').html(bookings[bookingId].booking.budget);

    $('#preloader').hide();
    $('#rate').show();
}

function setRate(r) {
    rate = r;
    $('.rate-stars').css('backgroundPosition', '0px -' + (52 * r) + 'px');

    return false;
}

function rateBooking() {
    $('#preloader').show();

    var userType = null;

    if(bookings[bookingId].demander.id == currentUser.id) {
        userType = 'provider';
    }
    else {
        userType = 'demander';
    }

    $.ajax({
        url: 'http://backend.liquidtalent.com/booking/rate_' + userType + '?' +
                'token=' + currentUser.token +
                '&booking_id=' + bookingId +
                '&rate=' + rate +
                '&review=' + $('#review').val(),
        error: Response
    }).done(function (data) {
        if (data['status'] === 'failed') {
            alert(data['errors'][0]);
        }
        else {
            completeBooking(function() {
                loadPage('/projects');
            });
        }

        $('#preloader').hide();
    });
}

function acceptBooking() {
    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/booking/accept?' +
                'token=' + currentUser.token +
                '&booking_id=' + bookingId,
        error: Response
    }).done(function (data) {
        if (data['status'] === 'failed') {
            alert(data['errors'][0]);
            $('#preloader').hide();
        }
        else {
            alert('You have successfully accepted this project.');
            loadPage('/projects');
        }
    });
}

function rejectBooking() {
    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/booking/reject?' +
                'token=' + currentUser.token +
                '&booking_id=' + bookingId,
        error: Response
    }).done(function (data) {
        if (data['status'] === 'failed') {
            alert(data['errors'][0]);
            $('#preloader').hide();
        }
        else {
            alert('You have successfully rejected this project.');
            loadPage('/projects');
        }
    });
}

function completeBooking(callback) {
    $.ajax({
        url: 'http://backend.liquidtalent.com/booking/complete?' +
                'token=' + currentUser.token +
                '&booking_id=' + bookingId,
        error: Response
    }).done(function (data) {
        if (data['status'] === 'failed') {
            alert(data['errors'][0]);
        }
        else {
            callback();
        }
    });
}

function submitSettingsContactForm() {
    $('#preloader').show();

    $.ajax({
        url: cF.href,
        type: 'post',
        data: 'name=' + cF.n.val() + '&email=' + cF.e.val() + '&message=' + cF.m.val(),
        error: Response
    }).done(function () {
        $('#preloader').hide();

        }).done(function (response) {
            if (response.success !== '') { alert(response.success); }
            else { alert(response.error); }

            cF.n.val('');
            cF.e.val('');
            cF.m.val('');
        });
}

function editProfile() {
    $('#preloader').show();

    if(currentUser.is_provider == 1) {
        loadPage('/update_provider');
    }
    else {
        loadPage('/update_demander');
    }

    $('#preloader').hide();
}

function updateProvider() {
    $('#preloader').show();

    $.ajax({
        url: 'http://backend.liquidtalent.com/user/set_details?' +
                'user_id=' + currentUser.id +
                '&token=' + currentUser.token +
                '&attr[category_id]=' + $('#category_id').val() +
                '&attr[school_id]=' + $('#school_id').val() +
                '&attr[description]=' + $('.description').val() +
                '&attr[summary]=' + $('.summary').val() +
                '&attr[hourly_rate]=' + $('.hourly_rate').val() +
                '&attr[skills]=' + $('.skills').val() +
                '&attr[portfolio]=' + $('.portfolio').val() +
                '&attr[experience]=' + $('.experience').val() +
                '&attr[years_in_industry]=' + $('.years_in_industry').val(),
        error: Response
    }).done(function (data) {
        if (data['status'] === 'failed') {
            alert(data['errors'][0]);
        }
        else {
            token = currentUser.token;
            currentUser = data.response;
            currentUser.token = token;

            alert('You have successfully updated your profile.');
        }

        $('#preloader').hide();
    });
}


function updateDemander() {
    $('#preloader').show();

    if(avatar_change) {
        $.ajax({
            url: 'http://backend.liquidtalent.com/user/set_avatar',
            type: 'POST',
            contentType: false,
            processData: false,
            data: function () {
                var rq_data = new FormData();
                rq_data.append("user_id", currentUser.id);
                rq_data.append("token", currentUser.token);
                rq_data.append("avatar", $('#avatar').get(0).files[0]);
                return rq_data;
            }(),
            error: Response
        }).done(function (avatar_data) {
                    if (avatar_data['status'] === 'failed') {
                        alert(avatar_data['errors'][0]);
                    }
                    else {
                        currentUser['avatar_url'] = avatar_data['response']['url'];

                        $('#user-info .avatar').attr('src', currentUser['avatar_url']);

                        updateDemanderData();
                    }
        });
    }
    else {
        updateDemanderData();
    }
}

function updateDemanderData() {
    //  Validate password
    if($('.password').val() != $('.password_confirmation').val()) {
        alert('Passwords are not the same.');
        return false;
    }
    if($('.password').val().length > 0 && $('.password').val().length < 5) {
        alert('Your password is too short.');
        return false;
    }

    $.ajax({
        url: 'http://backend.liquidtalent.com/user/set_details?' +
                'user_id=' + currentUser.id +
                '&token=' + currentUser.token +
                '&attr[name]=' + $('.name').val() +
                '&attr[email]=' + $('.email').val() +
                '&attr[zip]=' + $('.zip').val() +
                '&attr[company_name]=' + $('.company_name').val() +
                '&attr[title]=' + $('.title').val() +
                '&attr[category_id]=' + $('#category_id').val() +
                ( ($('.password').val().length > 0) ? ('&attr[password]=' + $('.password').val()) : null ),
        error: Response
    }).done(function (data) {
                if (data['status'] === 'failed') {
                    alert(data['errors'][0]);
                }
                else {
                    token = currentUser.token;
                    currentUser = data.response;
                    currentUser.token = token;

                    alert('You have successfully updated your profile.');
                }

                $('#preloader').hide();
            });
}